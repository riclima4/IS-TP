{% extends "base.html" %}
{% block content %}
<div class="card">
    {% if success %}
    <div class="card flash-card" style="background:#f0fdf4;border:1px solid #bbf7d0;color:#15803d">
        <strong>Success:</strong> {{ message }}
    </div>
    {% endif %}
    {% if error %}
    <div class="card flash-card" style="background:#fff3f3;border:1px solid #fecaca;color:#b91c1c">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cards = document.querySelectorAll('.flash-card');
            cards.forEach(card => {
                setTimeout(() => {
                    card.style.transition = 'opacity .4s, transform .4s';
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(-6px)';
                    setTimeout(() => card.remove(), 450);
                }, 5000); // 5s timeout
            });
        });
    </script>
    <form method="post" action="/convert" enctype="multipart/form-data" style="margin-bottom:28px">
        <div
            style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;margin:16px 0 8px">
            <h3 style="margin:0">Upload CSV</h3>
        </div>
        <div class="drop-zone" data-placeholder="Choose CSV file" id="csvZone">
            <span class="dz-label">Choose CSV file</span>
            <input type="file" id="csvfile" name="csvfile" accept=".csv" required style="display:none">
            <small>Drag & drop your .csv here or click</small>
        </div>
        <div class="controls" style="margin-top:10px">
            <button class="btn secondary" type="submit">Upload CSV</button>
        </div>
    </form>

    <div style="margin-bottom:24px">
        <strong style="display:block;margin-bottom:6px">Existing CSV files</strong>
        {% if csv_files and csv_files|length > 0 %}
        <ul
            style="list-style:none;padding:0;margin:0;max-height:220px;overflow:auto;border:1px solid #e2e8f0;border-radius:6px">
            {% for f in csv_files %}
            <li
                style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:6px 10px;border-bottom:1px solid #f1f5f9;font-size:0.9rem">
                <span>{{ f }}</span>
                <div style="display:flex;gap:6px">
                    <form method="post" action="/rpc_generate_xml" style="margin:0">
                        <input type="hidden" name="csv_name" value="{{ f }}" />
                        <button class="btn" type="submit"
                            style="padding:4px 10px;font-size:0.9rem;background-color:#2563eb">Generate XML &
                            XSD</button>
                    </form>
                    <form method="post" action="/remove_csv" style="margin:0"
                        onsubmit="return confirm('Remove CSV {{ f }}?');">
                        <input type="hidden" name="csv_name" value="{{ f }}" />
                        <button class="btn" type="submit" aria-label="Delete CSV {{ f }}" title="Delete"
                            style="background-color:#dc2626;display:flex;align-items:center;justify-content:center;padding:4px;border-radius:6px;">
                            Remove
                        </button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="muted" style="font-size:0.9rem">No CSV files uploaded yet.</p>
        {% endif %}
    </div>

    <div style="margin-bottom:24px">
        <strong style="display:block;margin:10px 0 6px">XML files</strong>
        {% if xml_items and xml_items|length > 0 %}
        <ul
            style="list-style:none;padding:0;margin:0;max-height:180px;overflow:auto;border:1px solid #e2e8f0;border-radius:6px">
            {% for xml_name, xsd_name in xml_items %}
            <li
                style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-bottom:1px solid #f1f5f9;font-size:0.9rem">
                <span>
                    {{ xml_name }}
                    {% if xsd_name %}
                    â†’ <em style="color:#64748b">{{ xsd_name }}</em>
                    {% else %}
                    <em class="muted" style="margin-left:6px">(no XSD)</em>
                    {% endif %}
                </span>
                <div style="display: flex; gap:6px;flex-wrap:wrap">
                    {% if xsd_name %}
                    <form method="post" action="/rpc_validate" style="margin:0">
                        <input type="hidden" name="xml_name" value="{{ xml_name }}" />
                        <input type="hidden" name="xsd_name" value="{{ xsd_name }}" />
                        <button class="btn" type="submit"
                            style="padding:4px 8px;font-size:0.9rem;background-color:#1fbb48">Validate</button>
                    </form>
                    <form method="post" action="/rpc_process_xml" style="margin:0">
                        <input type="hidden" name="xml_name" value="{{ xml_name }}" />
                        <button class="btn" type="submit"
                            style="padding:4px 8px;font-size:0.9rem;background-color:#eb9f25">Send to DB</button>
                    </form>
                    {% endif %}
                    <form method="post" action="/remove_xml_xsd" style="margin:0"
                        onsubmit="return confirm('Remove XML {{ xml_name }}{% if xsd_name %} and XSD {{ xsd_name }}{% endif %}?');">
                        <input type="hidden" name="xml_name" value="{{ xml_name }}" />
                        {% if xsd_name %}
                        <input type="hidden" name="xsd_name" value="{{ xsd_name }}" />
                        {% endif %}
                        <button class="btn" type="submit" aria-label="Delete XML/XSD {{ xml_name }}" title="Delete"
                            style="background-color:#dc2626;display:flex;align-items:center;justify-content:center;padding:4px;border-radius:6px;">
                            Remove
                        </button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="muted" style="font-size:0.9rem">No XML files found.</p>
        {% endif %}
    </div>

    <div style="margin-bottom:24px">
        <strong style="display:block;margin:10px 0 6px">Firestore Collections</strong>
        {% if db_collections and db_collections|length > 0 %}
        <ul
            style="list-style:none;padding:0;margin:0;max-height:150px;overflow:auto;border:1px solid #e2e8f0;border-radius:6px">
            {% for col in db_collections %}
            <li style="padding:6px 10px;border-bottom:1px solid #f1f5f9;font-size:0.9rem">{{ col }}</li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="muted" style="font-size:0.9rem">No collections found (or RPC unavailable).</p>
        {% endif %}
    </div>

    <div class="card" style="margin-top:24px">
        <h3 style="margin:0 0 12px">Group By</h3>
        <form method="post" action="/rpc_group" style="display:grid;gap:10px">
            <div class="row">
                <label>XML file</label>
                <select class="select" name="xml_name" required>
                    {% for xml_name, xsd_name in xml_items %}
                    <option value="{{ xml_name }}">{{ xml_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="row">
                <label>Group tag (header)</label>
                <input class="select" type="text" name="group_tag" placeholder="e.g. country" required />
            </div>
            <div class="row">
                <label>Output name (optional)</label>
                <input class="select" type="text" name="output_name" placeholder="grouped_output" />
            </div>
            <div class="row">
                <label>Aggregations (optional)</label>
                <div id="agg-list" style="display:grid;gap:6px"></div>
                <button type="button" class="btn secondary" onclick="addAgg()" style="width:auto">Add
                    aggregation</button>
                <small class="muted">Aggregation examples: field=sales, op=sum|avg|min|max|count (count ignores
                    field)</small>
            </div>
            <div class="controls">
                <button class="btn" type="submit">Run Group</button>
            </div>
        </form>
    </div>

</div>

<script>
    // Additional visual tweaks after global script sets labels
    ['csvZone', 'xmlZone'].forEach(id => {
        const zone = document.getElementById(id);
        if (zone) {
            zone.addEventListener('dragenter', () => zone.style.transform = 'scale(1)');
            zone.addEventListener('dragleave', () => zone.style.transform = 'scale(1)');
            zone.addEventListener('drop', () => zone.style.transform = 'scale(1)');
        }
    });

</script>
<script>
    function addAgg() {
        const container = document.getElementById('agg-list');
        const row = document.createElement('div');
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr 180px auto';
        row.style.gap = '6px';
        row.innerHTML = `
            <input class="select" type="text" name="agg_field" placeholder="field (leave empty for count)" />
            <select class="select" name="agg_op">
                <option value="">-- op --</option>
                <option value="count">count</option>
                <option value="sum">sum</option>
                <option value="avg">avg</option>
                <option value="min">min</option>
                <option value="max">max</option>
            </select>
            <button type="button" class="btn" style="background:#ef4444;width:auto" onclick="this.parentElement.remove()">Remove</button>
        `;
        container.appendChild(row);
    }
</script>
{% endblock %}